popoto=function(){var a={version:"1.1.2",start:function(b){a.logger.info("Popoto "+a.version+" start on "+b);a.graph.mainLabel=b;if(void 0===a.rest.CYPHER_URL)a.logger.error("popoto.rest.CYPHER_URL is not set but is required.");else{a.checkHtmlComponents();a.taxonomy.isActive&&a.taxonomy.createTaxonomyPanel();if(a.graph.isActive)if(a.graph.createGraphArea(),a.graph.createForceLayout(),"string"===typeof b||b instanceof String){var c=a.provider.getSchema(b);void 0!==c?a.graph.addSchema(c):a.graph.addRootNode(b)}else a.graph.addSchema(b);
a.queryviewer.isActive&&a.queryviewer.createQueryArea();a.cypherviewer.isActive&&a.cypherviewer.createQueryArea();a.update()}},checkHtmlComponents:function(){var b=d3.select("#"+a.graph.containerId),c=d3.select("#"+a.taxonomy.containerId),d=d3.select("#"+a.queryviewer.containerId),f=d3.select("#"+a.cypherviewer.containerId),e=d3.select("#"+a.result.containerId);b.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.graph.containerId+'" no graph area will be generated. This ID is defined in popoto.graph.containerId property.'),
a.graph.isActive=!1):a.graph.isActive=!0;c.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.taxonomy.containerId+'" no taxonomy filter will be generated. This ID is defined in popoto.taxonomy.containerId property.'),a.taxonomy.isActive=!1):a.taxonomy.isActive=!0;d.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.queryviewer.containerId+'" no query viewer will be generated. This ID is defined in popoto.queryviewer.containerId property.'),a.queryviewer.isActive=
!1):a.queryviewer.isActive=!0;f.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.cypherviewer.containerId+'" no cypher query viewer will be generated. This ID is defined in popoto.cypherviewer.containerId property.'),a.cypherviewer.isActive=!1):a.cypherviewer.isActive=!0;e.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.result.containerId+'" no result area will be generated. This ID is defined in popoto.result.containerId property.'),a.result.isActive=
!1):a.result.isActive=!0},update:function(){a.updateGraph();var b=a.graph.getRootNode();b&&void 0!==b.label&&(a.queryviewer.isActive&&a.queryviewer.updateQuery(),a.cypherviewer.isActive&&a.cypherviewer.updateQuery(),(a.result.isActive||0<a.result.resultListeners.length||0<a.result.resultCountListeners.length||0<a.result.graphResultListeners.length)&&a.result.updateResults())},updateGraph:function(){a.graph.isActive&&(a.graph.force.start(),a.graph.link.updateLinks(),a.graph.node.updateNodes())},rest:{}};
a.rest.CYPHER_URL="http://localhost:7474/db/data/transaction/commit";a.rest.post=function(b){b=JSON.stringify(b);a.logger.info("REST POST:"+b);return $.ajax({type:"POST",beforeSend:function(b){a.rest.AUTHORIZATION&&b.setRequestHeader("Authorization",a.rest.AUTHORIZATION)},url:a.rest.CYPHER_URL,contentType:"application/json",data:b})};a.logger={};a.logger.LogLevels=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4});a.logger.LEVEL=a.logger.LogLevels.NONE;a.logger.TRACE=!1;a.logger.log=function(b,
c){if(console&&b>=a.logger.LEVEL)switch(a.logger.TRACE&&(c=c+"\n"+Error().stack),b){case a.logger.LogLevels.DEBUG:console.log(c);break;case a.logger.LogLevels.INFO:console.log(c);break;case a.logger.LogLevels.WARN:console.warn(c);break;case a.logger.LogLevels.ERROR:console.error(c)}};a.logger.debug=function(b){a.logger.log(a.logger.LogLevels.DEBUG,b)};a.logger.info=function(b){a.logger.log(a.logger.LogLevels.INFO,b)};a.logger.warn=function(b){a.logger.log(a.logger.LogLevels.WARN,b)};a.logger.error=
function(b){a.logger.log(a.logger.LogLevels.ERROR,b)};a.taxonomy={};a.taxonomy.containerId="popoto-taxonomy";a.taxonomy.createTaxonomyPanel=function(){var b=d3.select("#"+a.taxonomy.containerId).append("ul").attr("class","ppt-taxo-ul"),c=a.taxonomy.generateTaxonomiesData(),b=b.selectAll(".taxo").data(c).enter().append("li").attr("id",function(a){return a.id}).attr("value",function(a){return a.label});b.append("span").attr("class","ppt-icon ppt-taxo-tag").html("&nbsp;");b.append("span").attr("class",
"ppt-label").text(function(b){return a.provider.getTaxonomyTextValue(b.label)});b.append("span").attr("class","ppt-count");b.on("click",a.taxonomy.onClick);a.taxonomy.addTaxonomyChildren(b);var d=[];c.forEach(function(b){d.push(b);b.children&&a.taxonomy.flattenChildren(b,d)});a.graph.DISABLE_COUNT||a.taxonomy.updateCount(d)};a.taxonomy.flattenChildren=function(b,c){b.children.forEach(function(b){c.push(b);b.children&&c.concat(a.taxonomy.flattenChildren(b,c))})};a.taxonomy.updateCount=function(b){var c=
[];b.forEach(function(b){c.push({statement:a.query.generateTaxonomyCountQuery(b.label)})});(function(b){a.logger.info("Count taxonomies ==> ");a.rest.post({statements:c}).done(function(a){for(var c=0;c<b.length;c++){var d=0;a&&a.hasOwnProperty("results")&&0<a.results.length&&(d=a.results[c].data[0].row[0]);d3.select("#"+b[c].id).select(".ppt-count").text(" ("+d+")")}}).fail(function(b,c,d){a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+
d);d3.select("#popoto-taxonomy").selectAll(".ppt-count").text(" (0)")})})(b)};a.taxonomy.addTaxonomyChildren=function(b){b.each(function(b){var c=d3.select(this),f=b.children;b.children&&(b=c.append("ul").attr("class","ppt-taxo-sub-ul").selectAll("li").data(f).enter().append("li").attr("id",function(a){return a.id}).attr("value",function(a){return a.label}),b.append("span").attr("class","ppt-icon ppt-taxo-tag").html("&nbsp;"),b.append("span").attr("class","ppt-label").text(function(b){return a.provider.getTaxonomyTextValue(b.label)}),
b.append("span").attr("class","ppt-count"),b.on("click",a.taxonomy.onClick),a.taxonomy.addTaxonomyChildren(b))})};a.taxonomy.onClick=function(){d3.event.stopPropagation();for(var b=this.attributes.value.value;0<a.graph.force.nodes().length;)a.graph.force.nodes().pop();for(;0<a.graph.force.links().length;)a.graph.force.links().pop();a.graph.node.internalLabels={};a.update();a.graph.mainLabel=b;void 0!==a.provider.getSchema(b)?a.graph.addSchema(a.provider.getSchema(b)):a.graph.addRootNode(b);a.graph.hasGraphChanged=
!0;a.result.hasChanged=!0;a.update();a.tools.center()};a.taxonomy.generateTaxonomiesData=function(){var b=0,c=[],d;for(d in a.provider.nodeProviders)a.provider.nodeProviders.hasOwnProperty(d)&&a.provider.getProperty(d,"isSearchable")&&!a.provider.nodeProviders[d].parent&&c.push({label:d,id:"popoto-lbl-"+b++});c.forEach(function(c){a.provider.getProvider(c.label).hasOwnProperty("children")&&(b=a.taxonomy.addChildrenData(c,b))});return c};a.taxonomy.addChildrenData=function(b,c){b.children=[];a.provider.getProvider(b.label).children.forEach(function(d){var f=
a.provider.getProvider(d),e={label:d,id:"popoto-lbl-"+c++};f.hasOwnProperty("children")&&(c=a.taxonomy.addChildrenData(e,c));a.provider.getProperty(d,"isSearchable")&&b.children.push(e)});return c};a.tools={};a.tools.CENTER_GRAPH=!0;a.tools.RESET_GRAPH=!0;a.tools.SAVE_GRAPH=!1;a.tools.TOGGLE_TAXONOMY=!0;a.tools.TOGGLE_FULL_SCREEN=!0;a.tools.reset=function(){for(;0<a.graph.force.nodes().length;)a.graph.force.nodes().pop();for(;0<a.graph.force.links().length;)a.graph.force.links().pop();a.graph.node.internalLabels=
{};a.update();"string"===typeof a.graph.mainLabel||a.graph.mainLabel instanceof String?void 0!==a.provider.getSchema(a.graph.mainLabel)?a.graph.addSchema(a.provider.getSchema(a.graph.mainLabel)):a.graph.addRootNode(a.graph.mainLabel):a.graph.addSchema(a.graph.mainLabel);a.graph.hasGraphChanged=!0;a.result.hasChanged=!0;a.update();a.tools.center()};a.tools.center=function(){a.graph.zoom.translate([0,0]).scale(1);a.graph.svg.transition().attr("transform","translate("+a.graph.zoom.translate()+") scale("+
a.graph.zoom.scale()+")")};a.tools.toggleTaxonomy=function(){var b=d3.select("#"+a.taxonomy.containerId);b.filter(".disabled").empty()?b.classed("disabled",!0):b.classed("disabled",!1);a.graph.centerRootNode()};a.tools.toggleFullScreen=function(){var b=document.getElementById(a.graph.containerId);document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():
document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)};a.graph={};a.graph.containerId="popoto-graph";a.graph.hasGraphChanged=!0;a.graph.zoom=d3.behavior.zoom().scaleExtent([.1,10]);a.graph.WHEEL_ZOOM_ENABLED=!0;a.graph.TOOL_TAXONOMY=
"Show/hide taxonomy panel";a.graph.TOOL_CENTER="Center view";a.graph.TOOL_FULL_SCREEN="Full screen";a.graph.TOOL_RESET="Reset graph";a.graph.TOOL_SAVE="Save graph";a.graph.Events=Object.freeze({NODE_ROOT_ADD:"root.node.add",NODE_EXPAND_RELATIONSHIP:"node.expandRelationship",GRAPH_SAVE:"graph.save"});a.graph.saveListeners=[];a.graph.onSave=function(b){a.graph.saveListeners.push(b)};a.graph.setDefaultGraph=function(b){a.graph.mainLabel=b};a.graph.createGraphArea=function(){var b=d3.select("#"+a.graph.containerId),
c=b.append("div").attr("class","ppt-toolbar");if(a.tools.RESET_GRAPH)c.append("span").attr("id","popoto-reset-menu").attr("class","ppt-icon ppt-menu reset").attr("title",a.graph.TOOL_RESET).on("click",a.tools.reset);if(a.taxonomy.isActive&&a.tools.TOGGLE_TAXONOMY)c.append("span").attr("id","popoto-taxonomy-menu").attr("class","ppt-icon ppt-menu taxonomy").attr("title",a.graph.TOOL_TAXONOMY).on("click",a.tools.toggleTaxonomy);if(a.tools.CENTER_GRAPH)c.append("span").attr("id","popoto-center-menu").attr("class",
"ppt-icon ppt-menu center").attr("title",a.graph.TOOL_CENTER).on("click",a.tools.center);if(a.tools.TOGGLE_FULL_SCREEN)c.append("span").attr("id","popoto-fullscreen-menu").attr("class","ppt-icon ppt-menu fullscreen").attr("title",a.graph.TOOL_FULL_SCREEN).on("click",a.tools.toggleFullScreen);if(a.tools.SAVE_GRAPH)c.append("span").attr("id","popoto-save-menu").attr("class","ppt-icon ppt-menu save").attr("title",a.graph.TOOL_SAVE).on("click",function(){if(0<a.graph.saveListeners.length){var b=a.graph.getSchema();
a.graph.saveListeners.forEach(function(a){a(b)})}});b=b.append("svg").call(a.graph.zoom.on("zoom",a.graph.rescale));b.on("dblclick.zoom",null).attr("class","ppt-svg-graph");if(!a.graph.WHEEL_ZOOM_ENABLED)b.on("wheel.zoom",null).on("mousewheel.zoom",null);a.graph.svg=b.append("svg:g");a.graph.svg.append("g").attr("id",a.graph.link.gID);a.graph.svg.append("g").attr("id",a.graph.node.gID);window.addEventListener("resize",a.graph.centerRootNode)};a.graph.centerRootNode=function(){a.graph.getRootNode().px=
a.graph.getSVGWidth()/2;a.graph.getRootNode().py=a.graph.getSVGHeight()/2;a.update()};a.graph.getSVGWidth=function(){return"undefined"==typeof a.graph.svg||a.graph.svg.empty()?(a.logger.debug("popoto.graph.svg is undefined or empty."),0):document.getElementById(a.graph.containerId).clientWidth};a.graph.getSVGHeight=function(){return"undefined"==typeof a.graph.svg||a.graph.svg.empty()?(a.logger.debug("popoto.graph.svg is undefined or empty."),0):document.getElementById(a.graph.containerId).clientHeight};
a.graph.rescale=function(){a.graph.svg.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")};a.graph.LINK_DISTANCE=150;a.graph.LINK_STRENGTH=1;a.graph.FRICTION=.8;a.graph.CHARGE=-1400;a.graph.THETA=.8;a.graph.GRAVITY=0;a.graph.rootNodeAddListeners=[];a.graph.nodeExpandRelationshipListeners=[];a.graph.createForceLayout=function(){a.graph.force=d3.layout.force().size([a.graph.getSVGWidth(),a.graph.getSVGHeight()]).linkDistance(function(b){return b.type===a.graph.link.LinkTypes.RELATION?
3*a.graph.LINK_DISTANCE/2:a.graph.LINK_DISTANCE}).linkStrength(function(b){return b.linkStrength?b.linkStrength:a.graph.LINK_STRENGTH}).friction(a.graph.FRICTION).charge(function(b){return b.charge?b.charge:a.graph.CHARGE}).theta(a.graph.THETA).gravity(a.graph.GRAVITY).on("tick",a.graph.tick);a.graph.force.drag().on("dragstart",function(a){d3.event.sourceEvent.stopPropagation()}).on("dragend",function(a){d3.event.sourceEvent.stopPropagation()})};a.graph.on=function(b,c){b===a.graph.Events.NODE_ROOT_ADD&&
a.graph.rootNodeAddListeners.push(c);b===a.graph.Events.NODE_EXPAND_RELATIONSHIP&&a.graph.nodeExpandRelationshipListeners.push(c);b===a.graph.Events.GRAPH_SAVE&&a.graph.saveListeners.push(c)};a.graph.addRootNode=function(b){0<a.graph.force.nodes().length&&a.logger.warn("popoto.graph.addRootNode is called but the graph is not empty.");a.graph.force.nodes().push({id:"0",type:a.graph.node.NodeTypes.ROOT,x:a.graph.getSVGWidth()/2,y:a.graph.getSVGHeight()/2,label:b,fixed:!0,internalLabel:a.graph.node.generateInternalLabel(b)});
a.graph.rootNodeAddListeners.forEach(function(b){b(a.graph.getRootNode())});a.provider.getIsAutoExpandRelations(b)&&a.graph.node.expandRelationData(a.graph.getRootNode())};a.graph.addSchema=function(b){0<a.graph.force.nodes().length&&a.logger.warn("popoto.graph.addSchema is called but the graph is not empty.");var c=0;b.hasOwnProperty("rel")&&(c=b.rel.length);c={id:"0",type:a.graph.node.NodeTypes.ROOT,x:a.graph.getSVGWidth()/2,y:a.graph.getSVGHeight()/2,label:b.label,fixed:!0,internalLabel:a.graph.node.generateInternalLabel(b.label),
linkExpanded:!0,linkCount:c,count:1};b.hasOwnProperty("value")&&(c.value={id:++a.graph.node.idgen,parent:c,attributes:b.value,type:a.graph.node.NodeTypes.VALUE,label:c.label});a.graph.force.nodes().push(c);if(b.hasOwnProperty("rel"))for(var d=0;d<b.rel.length;d++)a.graph.addSchemaRelation(b.rel[d],c,d+1,b.rel.length)};a.graph.addSchemaRelation=function(b,c,d,f){d=a.graph.addSchemaNode(b.node,c,d,f);a.graph.force.links().push({id:"l"+ ++a.graph.node.idgen,source:c,target:d,type:a.graph.link.LinkTypes.RELATION,
label:b.label})};a.graph.addSchemaNode=function(b,c,d,f){var e=a.provider.getIsGroup(b),g=0;b.hasOwnProperty("rel")&&(g=b.rel.length);var h=a.graph.computeParentAngle(c);f=h?360/(f+1)*d:360/f*d;d=c.x+200*Math.cos(Math.PI/180*f-h);h=c.y+200*Math.sin(Math.PI/180*f-h);c={id:""+ ++a.graph.node.idgen,parent:c,type:e?a.graph.node.NodeTypes.GROUP:a.graph.node.NodeTypes.CHOOSE,label:b.label,fixed:!1,internalLabel:a.graph.node.generateInternalLabel(b.label),x:d,y:h,linkExpanded:!0,linkCount:g};b.hasOwnProperty("value")&&
(c.value={id:++a.graph.node.idgen,parent:c,attributes:b.value,type:a.graph.node.NodeTypes.VALUE,label:c.label});a.graph.force.nodes().push(c);if(b.hasOwnProperty("rel"))for(e=0;e<b.rel.length;e++)a.graph.addSchemaRelation(b.rel[e],c,e+1,b.rel.length);return c};a.graph.getRootNode=function(){return a.graph.force.nodes()[0]};a.graph.getSchema=function(){var b={},c=a.graph.getRootNode();b[c.id]={label:c.label};c.hasOwnProperty("value")&&(b[c.id].value=c.value.attributes);var d=a.graph.force.links();
0<d.length&&d.forEach(function(a){var c=a.source,d=a.target;b.hasOwnProperty(c.id)||(b[c.id]={label:c.label},c.hasOwnProperty("value")&&(b[c.id].value=c.value.attributes));b.hasOwnProperty(d.id)||(b[d.id]={label:d.label},d.hasOwnProperty("value")&&(b[d.id].value=d.value.attributes));b[c.id].hasOwnProperty("rel")||(b[c.id].rel=[]);b[c.id].rel.push({label:a.label,node:b[d.id]})});return b[c.id]};a.graph.tick=function(){var b=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g");b.selectAll("path").attr("d",
function(b){var c=a.graph.computeParentAngle(b.target),f=b.target.x+a.graph.link.RADIUS*Math.cos(c),e=b.target.y-a.graph.link.RADIUS*Math.sin(c),g=b.source.x-a.graph.link.RADIUS*Math.cos(c),c=b.source.y+a.graph.link.RADIUS*Math.sin(c);return b.source.x<=b.target.x?"M"+g+" "+c+"L"+f+" "+e:"M"+f+" "+e+"L"+g+" "+c});b.selectAll(".ppt-textPath").attr("xlink:href",function(a){return"#ppt-path_"+a.id});a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").attr("transform",function(a){return"translate("+a.x+
","+a.y+")"})};a.graph.link={};a.graph.link.RADIUS=25;a.graph.link.gID="popoto-glinks";a.graph.link.LinkTypes=Object.freeze({RELATION:0,VALUE:1});a.graph.link.updateLinks=function(){a.graph.link.svgLinkElements=a.graph.svg.select("#"+a.graph.link.gID).selectAll("g");a.graph.link.updateData();a.graph.link.removeElements();a.graph.link.addNewElements();a.graph.link.updateElements()};a.graph.link.updateData=function(){a.graph.link.svgLinkElements=a.graph.link.svgLinkElements.data(a.graph.force.links(),
function(a){return a.id})};a.graph.link.removeElements=function(){a.graph.link.svgLinkElements.exit().remove()};a.graph.link.addNewElements=function(){var b=a.graph.link.svgLinkElements.enter().append("g").attr("class","ppt-glink").on("mouseover",a.graph.link.mouseOverLink).on("mouseout",a.graph.link.mouseOutLink);b.append("path");b.append("text").attr("text-anchor","middle").attr("dy","-4").append("textPath").attr("class","ppt-textPath").attr("startOffset","50%")};a.graph.link.updateElements=function(){a.graph.link.svgLinkElements.attr("id",
function(a){return"ppt-glink_"+a.id});a.graph.link.svgLinkElements.selectAll("path").attr("id",function(a){return"ppt-path_"+a.id}).attr("class",function(b){return b.type===a.graph.link.LinkTypes.VALUE?"ppt-link-value":0==b.target.count?"ppt-link-relation disabled":void 0!==b.target.value?"ppt-link-relation value":"ppt-link-relation"});a.graph.link.svgLinkElements.selectAll("text").attr("id",function(a){return"ppt-text_"+a.id}).attr("class",function(b){return b.type===a.graph.link.LinkTypes.VALUE?
"ppt-link-text-value":0==b.target.count?"ppt-link-text-relation disabled":void 0!==b.target.value?"ppt-link-text-relation value":"ppt-link-text-relation"}).selectAll(".ppt-textPath").attr("id",function(a){return"ppt-textpath_"+a.id}).attr("xlink:href",function(a){return"#ppt-path_"+a.id}).text(function(b){return a.provider.getLinkTextValue(b)})};a.graph.link.mouseOverLink=function(){d3.select(this).select("path").classed("ppt-link-hover",!0);d3.select(this).select("text").classed("ppt-link-hover",
!0);var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!0));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.link===b}).classed("hover",!0)};a.graph.link.mouseOutLink=function(){d3.select(this).select("path").classed("ppt-link-hover",!1);d3.select(this).select("text").classed("ppt-link-hover",
!1);var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!1));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.link===b}).classed("hover",!1)};a.graph.node={};a.graph.node.gID="popoto-gnodes";a.graph.node.ELLIPSE_RX=50;a.graph.node.ELLIPSE_RY=25;a.graph.node.TEXT_Y=8;a.graph.node.BACK_CIRCLE_R=
70;a.graph.node.NODE_MAX_CHARS=11;a.graph.node.PAGE_SIZE=10;a.graph.DISABLE_COUNT=!1;a.graph.node.CountBox={x:16,y:33,w:52,h:19};a.graph.node.chooseWaiting=!1;a.graph.node.NodeTypes=Object.freeze({ROOT:0,CHOOSE:1,VALUE:2,GROUP:3});a.graph.node.idgen=0;a.graph.node.internalLabels={};a.graph.node.generateInternalLabel=function(b){b=b?b.toLowerCase().replace(/ /g,""):"n";if(b in a.graph.node.internalLabels)a.graph.node.internalLabels[b]+=1;else return a.graph.node.internalLabels[b]=0,b;return b+a.graph.node.internalLabels[b]};
a.graph.node.updateNodes=function(){a.graph.node.svgNodeElements||(a.graph.node.svgNodeElements=a.graph.svg.select("#"+a.graph.node.gID).selectAll("g"));a.graph.node.updateData();a.graph.node.removeElements();a.graph.node.addNewElements();a.graph.node.updateElements()};a.graph.node.updateData=function(){a.graph.node.svgNodeElements=a.graph.node.svgNodeElements.data(a.graph.force.nodes(),function(a){return a.id});a.graph.hasGraphChanged&&!a.graph.DISABLE_COUNT&&a.graph.node.updateCount();a.graph.hasGraphChanged=
!1};a.graph.node.updateCount=function(){var b=[],c=a.graph.force.nodes().filter(function(b){return a.graph.node.NodeTypes.VALUE!==b.type&&a.graph.node.NodeTypes.GROUP!==b.type});c.forEach(function(c){c=a.query.generateNodeCountQuery(c);b.push({statement:c.statement,parameters:c.parameters})});a.logger.info("Count nodes ==> ");a.rest.post({statements:b}).done(function(b){if(b){b.hasOwnProperty("errors")&&0<b.errors.length&&a.logger.error("Cypher query error:"+JSON.stringify(b.errors));if(b.hasOwnProperty("results")&&
0<b.results.length)for(var d=0;d<c.length;d++)c[d].count=b.results[d].data[0].row[0];else c.forEach(function(a){a.count=0});0<a.result.resultCountListeners.length&&a.result.updateResultsCount();a.graph.node.updateElements();a.graph.link.updateElements()}}).fail(function(b,f,e){a.logger.error(f+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+e);c.forEach(function(a){a.count=0});a.graph.node.updateElements();a.graph.link.updateElements()})};
a.graph.node.removeElements=function(){var b=a.graph.node.svgNodeElements.exit();b.filter(function(a){return!a.parent}).remove();b.filter(function(a){return a.parent}).transition().duration(300).attr("transform",function(a){return"translate("+a.parent.x+","+a.parent.y+")"}).remove()};a.graph.node.addNewElements=function(){var b=a.graph.node.svgNodeElements.enter().append("g").on("click",a.graph.node.nodeClick).on("mouseover",a.graph.node.mouseOverNode).on("mouseout",a.graph.node.mouseOutNode);b.filter(function(b){return b.type!==
a.graph.node.NodeTypes.VALUE}).on("contextmenu",a.graph.node.clearSelection);b.filter(function(b){return b.type===a.graph.node.NodeTypes.VALUE}).on("contextmenu",function(){d3.event.preventDefault()});b.append("title").attr("class","ppt-svg-title");a.graph.node.addBackgroundElements(b);a.graph.node.addMiddlegroundElements(b);a.graph.node.addForegroundElements(b)};a.graph.node.addBackgroundElements=function(b){b.append("g").attr("class","ppt-g-node-background").append("circle").attr("class",function(b){var c=
"ppt-node-background-circle";void 0!==b.value?c+=" selected-value":b.type===a.graph.node.NodeTypes.ROOT?c+=" root":b.type===a.graph.node.NodeTypes.CHOOSE?c+=" choose":b.type===a.graph.node.NodeTypes.VALUE?c+=" value":b.type===a.graph.node.NodeTypes.GROUP&&(c+=" group");return c}).style("fill-opacity",0).attr("r",a.graph.node.BACK_CIRCLE_R)};a.graph.node.addMiddlegroundElements=function(a){a.append("g").attr("class","ppt-g-node-middleground")};a.graph.node.addForegroundElements=function(b){b=b.append("g").attr("class",
"ppt-g-node-foreground");var c=b.filter(function(b){return b.type!==a.graph.node.NodeTypes.VALUE}).append("g").attr("class","ppt-rel-plus-icon");c.append("title").text("Add relationship");c.append("circle").attr("class","ppt-rel-plus-background").attr("cx","32").attr("cy","-43").attr("r","16");c.append("path").attr("class","ppt-rel-plus-path").attr("d","M 40,-45 35,-45 35,-50 30,-50 30,-45 25,-45 25,-40 30,-40 30,-35 35,-35 35,-40 40,-40 z");c.on("mouseover",function(){d3.select(this).select(".ppt-rel-plus-background").transition().style("fill-opacity",
.5)}).on("mouseout",function(){d3.select(this).select(".ppt-rel-plus-background").transition().style("fill-opacity",0)}).on("click",function(){d3.event.stopPropagation();a.graph.node.expandRelationship.call(this)});c=b.filter(function(b){return b.type!==a.graph.node.NodeTypes.VALUE}).append("g").attr("class","ppt-rel-minus-icon");c.append("title").text("Remove relationship");c.append("circle").attr("class","ppt-rel-minus-background").attr("cx","32").attr("cy","-43").attr("r","16");c.append("path").attr("class",
"ppt-rel-minus-path").attr("d","M 40,-45 25,-45 25,-40 40,-40 z");c.on("mouseover",function(){d3.select(this).select(".ppt-rel-minus-background").transition().style("fill-opacity",.5)}).on("mouseout",function(){d3.select(this).select(".ppt-rel-minus-background").transition().style("fill-opacity",0)}).on("click",function(){d3.event.stopPropagation();a.graph.node.collapseRelationship.call(this)});var c=b.filter(function(b){return b.type===a.graph.node.NodeTypes.ROOT||b.type===a.graph.node.NodeTypes.CHOOSE}).append("g").attr("class",
"ppt-node-foreground-g-arrows"),d=c.append("g");d.append("circle").attr("class","ppt-larrow").attr("cx","-43").attr("cy","-23").attr("r","17");d.append("path").attr("class","ppt-arrow").attr("d","m -44.905361,-23 6.742,-6.742 c 0.81,-0.809 0.81,-2.135 0,-2.944 l -0.737,-0.737 c -0.81,-0.811 -2.135,-0.811 -2.945,0 l -8.835,8.835 c -0.435,0.434 -0.628,1.017 -0.597,1.589 -0.031,0.571 0.162,1.154 0.597,1.588 l 8.835,8.834 c 0.81,0.811 2.135,0.811 2.945,0 l 0.737,-0.737 c 0.81,-0.808 0.81,-2.134 0,-2.943 l -6.742,-6.743 z");
d.on("click",function(b){d3.event.stopPropagation();1<b.page&&(b.page--,a.graph.node.collapseNode(b),a.graph.node.expandNode(b))});c=c.append("g");c.append("circle").attr("class","ppt-rarrow").attr("cx","43").attr("cy","-23").attr("r","17");c.append("path").attr("class","ppt-arrow").attr("d","m 51.027875,-24.5875 -8.835,-8.835 c -0.811,-0.811 -2.137,-0.811 -2.945,0 l -0.738,0.737 c -0.81,0.81 -0.81,2.136 0,2.944 l 6.742,6.742 -6.742,6.742 c -0.81,0.81 -0.81,2.136 0,2.943 l 0.737,0.737 c 0.81,0.811 2.136,0.811 2.945,0 l 8.835,-8.836 c 0.435,-0.434 0.628,-1.017 0.597,-1.588 0.032,-0.569 -0.161,-1.152 -0.596,-1.586 z");
c.on("click",function(b){d3.event.stopPropagation();b.page*a.graph.node.PAGE_SIZE<b.count&&(b.page++,a.graph.node.collapseNode(b),a.graph.node.expandNode(b))});a.graph.DISABLE_COUNT||(b=b.filter(function(b){return b.type!==a.graph.node.NodeTypes.GROUP}),b.append("rect").attr("x",a.graph.node.CountBox.x).attr("y",a.graph.node.CountBox.y).attr("width",a.graph.node.CountBox.w).attr("height",a.graph.node.CountBox.h).attr("class","ppt-count-box"),b.append("text").attr("x",42).attr("y",48).attr("text-anchor",
"middle").attr("class","ppt-count-text"))};a.graph.node.updateElements=function(){a.graph.node.svgNodeElements.attr("id",function(a){return"popoto-gnode_"+a.id});a.graph.node.svgNodeElements.selectAll(".ppt-svg-title").text(function(b){return a.provider.getTextValue(b)});a.graph.node.svgNodeElements.filter(function(b){return b.type!==a.graph.node.NodeTypes.ROOT}).call(a.graph.force.drag);a.graph.node.updateBackgroundElements();a.graph.node.updateMiddlegroundElements();a.graph.node.updateForegroundElements()};
a.graph.node.updateBackgroundElements=function(){a.graph.node.svgNodeElements.selectAll(".ppt-g-node-background").selectAll(".ppt-node-background-circle").attr("class",function(b){var c="ppt-node-background-circle";b.type===a.graph.node.NodeTypes.VALUE?c+=" value":b.type===a.graph.node.NodeTypes.GROUP?c+=" group":void 0!==b.value?b.type===a.graph.node.NodeTypes.ROOT?c+=" selected-root-value":b.type===a.graph.node.NodeTypes.CHOOSE&&(c+=" selected-value"):0==b.count?c+=" disabled":b.type===a.graph.node.NodeTypes.ROOT?
c+=" root":b.type===a.graph.node.NodeTypes.CHOOSE&&(c+=" choose");return c}).attr("r",a.graph.node.BACK_CIRCLE_R)};a.graph.node.updateMiddlegroundElements=function(){var b=a.graph.node.svgNodeElements.selectAll(".ppt-g-node-middleground");b.selectAll("*").remove();b.filter(function(b){return a.provider.getNodeDisplayType(b)===a.provider.NodeDisplayTypes.IMAGE}).append("image").attr("class","ppt-node-image").attr("width",function(b){return a.provider.getImageWidth(b)}).attr("height",function(b){return a.provider.getImageHeight(b)}).attr("transform",
function(b){return"translate("+-a.provider.getImageWidth(b)/2+","+-a.provider.getImageHeight(b)/2+")"}).attr("xlink:href",function(b){return a.provider.getImagePath(b)});b.filter(function(b){return a.provider.getNodeDisplayType(b)===a.provider.NodeDisplayTypes.TEXT}).append("ellipse").attr("rx",a.graph.node.ELLIPSE_RX).attr("ry",a.graph.node.ELLIPSE_RY).attr("rx",a.graph.node.ELLIPSE_RX).attr("ry",a.graph.node.ELLIPSE_RY).attr("class",function(b){if(b.type===a.graph.node.NodeTypes.ROOT)return b.value?
"ppt-node-ellipse selected-root-value":0==b.count?"ppt-node-ellipse root disabled":"ppt-node-ellipse root";if(b.type===a.graph.node.NodeTypes.CHOOSE)return b.value?"ppt-node-ellipse selected-value":0==b.count?"ppt-node-ellipse choose disabled":"ppt-node-ellipse choose";if(b.type===a.graph.node.NodeTypes.VALUE)return"ppt-node-ellipse value";if(b.type===a.graph.node.NodeTypes.GROUP)return"ppt-node-ellipse group"});var c=b.filter(function(b){return a.provider.getNodeDisplayType(b)===a.provider.NodeDisplayTypes.SVG}).append("g").selectAll("path").data(function(b){return a.provider.getSVGPaths(b)});
c.exit().remove();c.enter().append("path");b.selectAll("path").attr("d",function(a){return a.d}).attr("class",function(a){return a["class"]});b.filter(function(b){return a.provider.isTextDisplayed(b)}).append("text").attr("x",0).attr("y",a.graph.node.TEXT_Y).attr("text-anchor","middle").attr("y",a.graph.node.TEXT_Y).attr("class",function(b){switch(b.type){case a.graph.node.NodeTypes.CHOOSE:return void 0===b.value?0==b.count?"ppt-node-text-choose disabled":"ppt-node-text-choose":"ppt-node-text-choose selected-value";
case a.graph.node.NodeTypes.GROUP:return"ppt-node-text-group";case a.graph.node.NodeTypes.ROOT:return void 0===b.value?0==b.count?"ppt-node-text-root disabled":"ppt-node-text-root":"ppt-node-text-root selected-value";case a.graph.node.NodeTypes.VALUE:return"ppt-node-text-value"}}).text(function(b){return a.provider.isTextDisplayed(b)?a.provider.getTextValue(b):""})};a.graph.node.updateForegroundElements=function(){var b=a.graph.node.svgNodeElements.selectAll(".ppt-g-node-foreground").selectAll(".ppt-node-foreground-g-arrows");
b.classed("active",function(b){return b.valueExpanded&&b.data&&b.data.length>a.graph.node.PAGE_SIZE});b.selectAll(".ppt-larrow").classed("enabled",function(a){return 1<a.page});b.selectAll(".ppt-rarrow").classed("enabled",function(b){return b.data?b.page*a.graph.node.PAGE_SIZE<b.data.length:!1});b=a.graph.node.svgNodeElements.selectAll(".ppt-g-node-foreground");b.selectAll(".ppt-count-box").filter(function(b){return b.type!==a.graph.node.NodeTypes.CHOOSE}).classed("root",!0);b.selectAll(".ppt-count-box").filter(function(b){return b.type===
a.graph.node.NodeTypes.CHOOSE}).classed("value",!0);b.selectAll(".ppt-count-box").classed("disabled",function(a){return 0==a.count});a.graph.DISABLE_COUNT||b.selectAll(".ppt-count-text").text(function(a){return null!=a.count?a.count:"..."}).classed("disabled",function(a){return 0==a.count});b.selectAll(".ppt-rel-plus-icon").classed("disabled",function(a){return a.linkExpanded||0==a.count||0==a.linkCount});b.selectAll(".ppt-rel-minus-icon").classed("disabled",function(a){return!a.linkExpanded||0==
a.count||0==a.linkCount})};a.graph.node.mouseOverNode=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];d3.select(this).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5);a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!0));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===
b}).classed("hover",!0)};a.graph.node.mouseOutNode=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];d3.select(this).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0);a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!1));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===
b}).classed("hover",!1)};a.graph.node.nodeClick=function(){if(!d3.event.defaultPrevented){var b=d3.select(this).data()[0];a.logger.debug("nodeClick ("+b.label+")");if(b.type===a.graph.node.NodeTypes.VALUE)a.graph.node.valueNodeClick(b);else if(b.type===a.graph.node.NodeTypes.CHOOSE||b.type===a.graph.node.NodeTypes.ROOT)b.valueExpanded?a.graph.node.collapseNode(b):a.graph.node.chooseNodeClick(b)}};a.graph.node.collapseNode=function(b){if(b.valueExpanded){a.logger.debug("collapseNode ("+b.label+")");
var c=a.graph.force.links().filter(function(c){return c.source===b&&c.type===a.graph.link.LinkTypes.VALUE});c.forEach(function(b){a.graph.force.nodes().splice(a.graph.force.nodes().indexOf(b.target),1)});for(var d=a.graph.force.links().length-1;0<=d;d--)0<=c.indexOf(a.graph.force.links()[d])&&a.graph.force.links().splice(d,1);b.type!==a.graph.node.NodeTypes.ROOT&&(b.fixed=!1);b.parent&&b.parent.type!==a.graph.node.NodeTypes.ROOT&&(b.parent.fixed=!1);b.valueExpanded=!1;a.update()}else a.logger.debug("collapseNode called on an unexpanded node")};
a.graph.node.valueNodeClick=function(b){a.logger.debug("valueNodeClick ("+b.label+")");b.parent.value=b;a.result.hasChanged=!0;a.graph.hasGraphChanged=!0;a.graph.node.collapseNode(b.parent)};a.graph.node.chooseNodeClick=function(b){a.logger.debug("chooseNodeClick ("+b.label+") with waiting state set to "+a.graph.node.chooseWaiting);if(!a.graph.node.chooseWaiting&&!b.immutable){a.graph.force.nodes().forEach(function(b){b.type!=a.graph.node.NodeTypes.ROOT&&b.type!=a.graph.node.NodeTypes.CHOOSE||!b.valueExpanded||
a.graph.node.collapseNode(b)});a.graph.node.chooseWaiting=!0;a.logger.info("Values ("+b.label+") ==> ");var c=a.query.generateNodeValueQuery(b);a.rest.post({statements:[{statement:c.statement,parameters:c.parameters}]}).done(function(c){c&&c.hasOwnProperty("errors")&&0<c.errors.length&&a.logger.error(JSON.stringify(c.errors));b.id=++a.graph.node.idgen;b.data=a.graph.node.parseResultData(c);b.page=1;a.graph.node.expandNode(b);a.graph.node.chooseWaiting=!1}).fail(function(b,c,e){a.graph.node.chooseWaiting=
!1;a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+e)})}};a.graph.node.parseResultData=function(a){var b=[];if(a&&a.hasOwnProperty("results")&&0<a.results.length)for(var d=0;d<a.results[0].data.length;d++){for(var f={},e=0;e<a.results[0].columns.length;e++)f[a.results[0].columns[e]]=a.results[0].data[d].row[e];b.push(f)}return b};a.graph.computeParentAngle=function(a){var b=0;if(a.parent){var b=a.parent.x,d=a.parent.y,
f=a.x;a=a.y;var e=100/(Math.sqrt(Math.pow(b-f,2)+Math.pow(d-a,2))-100),b=((f+e*b)/(1+e)-f)/100;-1>b&&(b=-1);1<b&&(b=1);b=Math.acos(b);d>a&&(b=2*Math.PI-b)}return b};a.graph.node.expandNode=function(b){var c=b.page*a.graph.node.PAGE_SIZE,d=b.data.slice(c-a.graph.node.PAGE_SIZE,c),f=a.graph.computeParentAngle(b),e=1;d.forEach(function(c){var g;g=b.parent?360/(d.length+1)*e:360/d.length*e;var k=b.x+100*Math.cos(Math.PI/180*g-f);g=b.y+100*Math.sin(Math.PI/180*g-f);c={id:++a.graph.node.idgen,parent:b,
attributes:c,type:a.graph.node.NodeTypes.VALUE,label:b.label,count:c.count,x:k,y:g,internalID:c[a.query.NEO4J_INTERNAL_ID.queryInternalName]};a.graph.force.nodes().push(c);a.graph.force.links().push({id:"l"+ ++a.graph.node.idgen,source:b,target:c,type:a.graph.link.LinkTypes.VALUE});e++});b.fixed=!0;b.parent&&b.parent.type!==a.graph.node.NodeTypes.ROOT&&(b.parent.fixed=!0);b.valueExpanded=!0;a.update()};a.graph.node.expandRelationship=function(){d3.event.preventDefault();a.graph.nodeExpandRelationshipListeners.forEach(function(a){a(this)});
var b=d3.select(this).data()[0];b.linkExpanded||a.graph.node.linkWaiting||b.valueExpanded||a.graph.node.expandRelationData(b)};a.graph.node.expandRelationData=function(b){a.graph.node.linkWaiting=!0;a.logger.info("Relations ("+b.label+") ==> ");var c=a.query.generateNodeRelationQuery(b);a.rest.post({statements:[{statement:c.statement,parameters:c.parameters}]}).done(function(c){c&&c.hasOwnProperty("errors")&&0<c.errors.length&&a.logger.error(JSON.stringify(c.errors));c=a.graph.node.parseResultData(c);
c=c.filter(function(b){return a.query.filterRelation(b)});0<c.length&&a.graph.addRelationshipData(b,c);b.linkCount=c.length;b.linkExpanded=!0;a.graph.hasGraphChanged=!0;a.graph.node.linkWaiting=!1;a.update()}).fail(function(b,c,e){a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+e);a.graph.node.linkWaiting=!1})};a.graph.addRelationshipData=function(b,c){var d=a.graph.computeParentAngle(b),f=1;c.forEach(function(e){var g;
g=d?360/(c.length+1)*f:360/c.length*f;var h=b.x+100*Math.cos(Math.PI/180*g-d);g=b.y+100*Math.sin(Math.PI/180*g-d);var k=a.provider.getIsGroup(e),h={id:""+ ++a.graph.node.idgen,parent:b,type:k?a.graph.node.NodeTypes.GROUP:a.graph.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:a.graph.node.generateInternalLabel(e.label),x:h,y:g};a.graph.force.nodes().push(h);a.graph.force.links().push({id:"l"+ ++a.graph.node.idgen,source:b,target:h,type:a.graph.link.LinkTypes.RELATION,label:e.relationship});
a.provider.getIsAutoExpandRelations(h.label)&&void 0==a.provider.getSchema(a.graph.mainLabel)&&a.graph.node.expandRelationData(h);f++})};a.graph.node.collapseRelationship=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];if(b.linkExpanded&&0<b.linkCount&&!a.graph.node.linkWaiting&&!b.valueExpanded){a.graph.force.nodes().forEach(function(b){b.type!==a.graph.node.NodeTypes.CHOOSE&&b.type!==a.graph.node.NodeTypes.ROOT||!b.valueExpanded||a.graph.node.collapseNode(b)});var c=a.graph.force.links().filter(function(c){return c.source===
b&&c.type===a.graph.link.LinkTypes.RELATION});c.forEach(function(b){a.graph.node.removeNode(b.target)});for(var d=a.graph.force.links().length-1;0<=d;d--)0<=c.indexOf(a.graph.force.links()[d])&&a.graph.force.links().splice(d,1);b.linkExpanded=!1;a.result.hasChanged=!0;a.graph.hasGraphChanged=!0;a.update()}};a.graph.node.removeNode=function(b){var c=a.graph.force.links().filter(function(a){return a.source===b});c.forEach(function(b){a.graph.node.removeNode(b.target)});for(var d=a.graph.force.links().length-
1;0<=d;d--)0<=c.indexOf(a.graph.force.links()[d])&&a.graph.force.links().splice(d,1);a.graph.force.nodes().splice(a.graph.force.nodes().indexOf(b),1)};a.graph.node.clearSelection=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];a.graph.force.nodes().forEach(function(b){b.type!==a.graph.node.NodeTypes.CHOOSE&&b.type!==a.graph.node.NodeTypes.ROOT||!b.valueExpanded||a.graph.node.collapseNode(b)});null==b.value||b.immutable||(delete b.value,a.result.hasChanged=!0,a.graph.hasGraphChanged=
!0,a.update())};a.queryviewer={};a.queryviewer.containerId="popoto-query";a.queryviewer.QUERY_STARTER="I'm looking for";a.queryviewer.CHOOSE_LABEL="choose";a.queryviewer.createQueryArea=function(){var b="#"+a.queryviewer.containerId;a.queryviewer.queryConstraintSpanElements=d3.select(b).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan");a.queryviewer.querySpanElements=d3.select(b).append("p").attr("class","ppt-query-elements").selectAll(".querySpan")};a.queryviewer.updateQuery=
function(){a.queryviewer.queryConstraintSpanElements=a.queryviewer.queryConstraintSpanElements.data([]);a.queryviewer.querySpanElements=a.queryviewer.querySpanElements.data([]);a.queryviewer.queryConstraintSpanElements.exit().remove();a.queryviewer.querySpanElements.exit().remove();a.queryviewer.queryConstraintSpanElements=a.queryviewer.queryConstraintSpanElements.data(a.queryviewer.generateConstraintData(a.graph.force.links(),a.graph.force.nodes()));a.queryviewer.querySpanElements=a.queryviewer.querySpanElements.data(a.queryviewer.generateData(a.graph.force.links(),
a.graph.force.nodes()));a.queryviewer.queryConstraintSpanElements.enter().append("span").on("contextmenu",a.queryviewer.rightClickSpan).on("click",a.queryviewer.clickSpan).on("mouseover",a.queryviewer.mouseOverSpan).on("mouseout",a.queryviewer.mouseOutSpan);a.queryviewer.querySpanElements.enter().append("span").on("contextmenu",a.queryviewer.rightClickSpan).on("click",a.queryviewer.clickSpan).on("mouseover",a.queryviewer.mouseOverSpan).on("mouseout",a.queryviewer.mouseOutSpan);a.queryviewer.queryConstraintSpanElements.attr("id",
function(a){return a.id}).attr("class",function(b){return b.isLink?"ppt-span-link":b.type===a.graph.node.NodeTypes.ROOT?"ppt-span-root":b.type===a.graph.node.NodeTypes.CHOOSE?b.ref.value?"ppt-span-value":"ppt-span-choose":b.type===a.graph.node.NodeTypes.VALUE?"ppt-span-value":b.type===a.graph.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(a){return a.term+" "});a.queryviewer.querySpanElements.attr("id",function(a){return a.id}).attr("class",function(b){return b.isLink?"ppt-span-link":
b.type===a.graph.node.NodeTypes.ROOT?"ppt-span-root":b.type===a.graph.node.NodeTypes.CHOOSE?b.ref.value?"ppt-span-value":"ppt-span-choose":b.type===a.graph.node.NodeTypes.VALUE?"ppt-span-value":b.type===a.graph.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(a){return a.term+" "})};a.queryviewer.generateConstraintData=function(b,c){var d=[],f=0;d.push({id:f++,term:a.queryviewer.QUERY_STARTER});0<c.length&&d.push({id:f++,type:c[0].type,term:a.provider.getSemanticValue(c[0]),ref:c[0]});
b.forEach(function(b){var c=b.source,e=b.target;b.type===a.graph.link.LinkTypes.RELATION&&e.type!==a.graph.node.NodeTypes.GROUP&&e.value&&(c.type===a.graph.node.NodeTypes.GROUP&&d.push({id:f++,type:c.type,term:a.provider.getSemanticValue(c),ref:c}),d.push({id:f++,isLink:!0,term:a.provider.getLinkSemanticValue(b),ref:b}),e.type!==a.graph.node.NodeTypes.GROUP&&(e.value?d.push({id:f++,type:e.type,term:a.provider.getSemanticValue(e),ref:e}):d.push({id:f++,type:e.type,term:"<"+a.queryviewer.CHOOSE_LABEL+
" "+a.provider.getSemanticValue(e)+">",ref:e})))});return d};a.queryviewer.generateData=function(b,c){var d=[],f=[],e=0;b.forEach(function(b){var c=b.source,g=b.target;g.type===a.graph.node.NodeTypes.GROUP&&f.push({id:e++,type:g.type,term:a.provider.getSemanticValue(g),ref:g});b.type!==a.graph.link.LinkTypes.RELATION||g.type===a.graph.node.NodeTypes.GROUP||g.value||(c.type===a.graph.node.NodeTypes.GROUP&&d.push({id:e++,type:c.type,term:a.provider.getSemanticValue(c),ref:c}),d.push({id:e++,isLink:!0,
term:a.provider.getLinkSemanticValue(b),ref:b}),g.type!==a.graph.node.NodeTypes.GROUP&&(g.value?d.push({id:e++,type:g.type,term:a.provider.getSemanticValue(g),ref:g}):d.push({id:e++,type:g.type,term:"<"+a.queryviewer.CHOOSE_LABEL+" "+a.provider.getSemanticValue(g)+">",ref:g})))});return d.concat(f)};a.queryviewer.mouseOverSpan=function(){d3.select(this).classed("hover",function(a){return a.ref});var b=d3.select(this).data()[0];if(b.ref){var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===
b.ref});c.select("path").classed("ppt-link-hover",!0);c.select("text").classed("ppt-link-hover",!0);a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5);a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.ref||a.link===b.ref}).classed("hover",!0)}};a.queryviewer.rightClickSpan=function(){var b=d3.select(this).data()[0];if(!b.isLink&&
b.ref){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref});c.on("contextmenu").call(c.node(),b.ref)}};a.queryviewer.clickSpan=function(){var b=d3.select(this).data()[0];if(!b.isLink&&b.ref){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref});c.on("click").call(c.node(),b.ref)}};a.queryviewer.mouseOutSpan=function(){d3.select(this).classed("hover",!1);var b=d3.select(this).data()[0];if(b.ref){var c=a.graph.svg.selectAll("#"+
a.graph.link.gID+" > g").filter(function(a){return a===b.ref});c.select("path").classed("ppt-link-hover",!1);c.select("text").classed("ppt-link-hover",!1);a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0);a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.ref||a.link===b.ref}).classed("hover",!1)}};a.cypherviewer={};a.cypherviewer.containerId=
"popoto-cypher";a.cypherviewer.MATCH="MATCH";a.cypherviewer.RETURN="RETURN";a.cypherviewer.QueryElementTypes=Object.freeze({KEYWORD:0,NODE:1,SEPARATOR:2,SOURCE:3,LINK:4,TARGET:5,RETURN:6});a.cypherviewer.createQueryArea=function(){a.cypherviewer.querySpanElements=d3.select("#"+a.cypherviewer.containerId).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan")};a.cypherviewer.updateQuery=function(){a.cypherviewer.querySpanElements=a.cypherviewer.querySpanElements.data([]);
a.cypherviewer.querySpanElements.exit().remove();a.cypherviewer.querySpanElements=a.cypherviewer.querySpanElements.data(a.cypherviewer.generateData(a.graph.force.links(),a.graph.force.nodes()));a.cypherviewer.querySpanElements.enter().append("span").attr("id",function(a){return"cypher-"+a.id}).on("mouseover",a.cypherviewer.mouseOverSpan).on("mouseout",a.cypherviewer.mouseOutSpan).on("contextmenu",a.cypherviewer.rightClickSpan).on("click",a.cypherviewer.clickSpan);a.cypherviewer.querySpanElements.filter(function(b){return b.type===
a.cypherviewer.QueryElementTypes.KEYWORD}).attr("class","ppt-span").text(function(a){return" "+a.value+" "});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.SEPARATOR}).attr("class","ppt-span").text(function(a){return a.value+" "});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.NODE}).attr("class",function(a){return a.node.value?"ppt-span-root-value":"ppt-span-root"}).text(function(b){var c=
"";if(b.node.value)if(c=a.provider.getConstraintAttribute(b.node.label),c===a.query.NEO4J_INTERNAL_ID)c="{`id`:"+b.node.value.internalID+"}";else var d=b.node.value.attributes[c],c="boolean"===typeof d||"number"===typeof d?"{`"+c+"`:"+d+"}":"{`"+c+'`:"'+d+'"}';return"("+b.node.internalLabel+":`"+b.node.label+"`"+c+")"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.SOURCE}).attr("class",function(b){return b.node===a.graph.getRootNode()?b.node.value?
"ppt-span-root-value":"ppt-span-root":b.node.value?"ppt-span-value":"ppt-span-choose"}).text(function(a){a=a.node;return"("+a.internalLabel+":`"+a.label+"`)"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.LINK}).attr("class","ppt-span-link").text(function(b){return"-[:`"+b.link.label+"`]-"+(a.query.USE_RELATION_DIRECTION?">":"")});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.TARGET}).attr("class",
function(a){return a.node.value?"ppt-span-value":"ppt-span-choose"}).text(function(b){b=b.node;var c="";if(b.value)if(c=a.provider.getConstraintAttribute(b.label),c===a.query.NEO4J_INTERNAL_ID)c="{`id`:"+b.value.internalID+"}";else var d=b.value.attributes[c],c="boolean"===typeof d||"number"===typeof d?"{`"+c+"`:"+d+"}":"{`"+c+'`:"'+d+'"}';return"("+b.internalLabel+":`"+b.label+"`"+c+")"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.RETURN}).attr("class",
function(a){return a.node.value?"ppt-span-root-value":"ppt-span-root"}).text(function(a){return a.node.internalLabel})};a.cypherviewer.generateData=function(b){var c=[],d=0,f=a.graph.getRootNode();b=a.query.getRelevantLinks(f,f,b);c.push({id:d++,type:a.cypherviewer.QueryElementTypes.KEYWORD,value:a.cypherviewer.MATCH});f&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.NODE,node:f});0<b.length&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:","});for(var e=0;e<b.length;e++)c.push({id:d++,
type:a.cypherviewer.QueryElementTypes.SOURCE,node:b[e].source}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.LINK,link:b[e]}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.TARGET,node:b[e].target}),e<b.length-1&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:","});c.push({id:d++,type:a.cypherviewer.QueryElementTypes.KEYWORD,value:a.cypherviewer.RETURN});f&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.RETURN,node:f});return c};a.cypherviewer.mouseOverSpan=
function(){var b=d3.select(this).data()[0];if(b.node)a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.node}).classed("hover",!0),a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===
b.node}).classed("hover",!0));else if(b.link){d3.select(this).classed("hover",!0);var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===b.link});c.select("path").classed("ppt-link-hover",!0);c.select("text").classed("ppt-link-hover",!0)}};a.cypherviewer.mouseOutSpan=function(){var b=d3.select(this).data()[0];if(b.node)a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.node}).classed("hover",!1),a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===
b.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!1));else if(b.link){d3.select(this).classed("hover",!1);var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===b.link});c.select("path").classed("ppt-link-hover",
!1);c.select("text").classed("ppt-link-hover",!1)}};a.cypherviewer.clickSpan=function(){var b=d3.select(this).data()[0];if(b.node){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node});c.on("click").call(c.node(),b.node)}};a.cypherviewer.rightClickSpan=function(){var b=d3.select(this).data()[0];if(b.node){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node});c.on("contextmenu").call(c.node(),b.node)}};a.query={};a.query.RESULTS_PAGE_SIZE=
100;a.query.VALUE_QUERY_LIMIT=100;a.query.USE_PARENT_RELATION=!1;a.query.USE_RELATION_DIRECTION=!0;a.query.NEO4J_INTERNAL_ID=Object.freeze({queryInternalName:"NEO4JID"});a.query.filterRelation=function(a){return!0};a.query.generateTaxonomyCountQuery=function(b){var c=a.provider.getConstraintAttribute(b),d=[];a.provider.getPredefinedConstraints(b).forEach(function(a){d.push(a.replace(RegExp("\\$identifier","g"),"n"))});return c===a.query.NEO4J_INTERNAL_ID?"MATCH (n:`"+b+"`)"+(0<d.length?" WHERE "+
d.join(" AND "):"")+" RETURN count(DISTINCT ID(n)) as count":"MATCH (n:`"+b+"`)"+(0<d.length?" WHERE "+d.join(" AND "):"")+" RETURN count(DISTINCT n."+c+") as count"};a.query.generateQueryElements=function(b,c,d,f){var e=[],g=[],h=[],k={},n=a.query.USE_RELATION_DIRECTION?"->":"-";a.provider.getPredefinedConstraints(b.label).forEach(function(a){g.push(a.replace(RegExp("\\$identifier","g"),b.internalLabel))});if(b.value&&(f||b.immutable)){var l=a.provider.getConstraintAttribute(b.label);if(l===a.query.NEO4J_INTERNAL_ID)e.push("("+
b.internalLabel+":`"+b.label+"`)"),g.push("ID("+b.internalLabel+") = "+b.value.internalID);else{var p=b.internalLabel+"_"+l;k[p]=b.value.attributes[l];e.push("("+b.internalLabel+":`"+b.label+"`{`"+l+"`:{`"+p+"`}})")}}else e.push("("+b.internalLabel+":`"+b.label+"`)");var t=0;d.forEach(function(d){var l=d.source,m=d.target,p="r"+t++;h.push(p);a.provider.getPredefinedConstraints(m.label).forEach(function(a){g.push(a.replace(RegExp("\\$identifier","g"),m.internalLabel))});if(m.value&&m!==c&&(f||b.immutable)){var q=
a.provider.getConstraintAttribute(m.label),r=m.internalLabel+"_"+q;k[r]=m.value.attributes[q];q===a.query.NEO4J_INTERNAL_ID?(e.push("("+l.internalLabel+":`"+l.label+"`)-["+p+":`"+d.label+"`]"+n+"("+m.internalLabel+":`"+m.label+"`)"),g.push("ID("+m.internalLabel+") = "+m.value.internalID)):e.push("("+l.internalLabel+":`"+l.label+"`)-["+p+":`"+d.label+"`]"+n+"("+m.internalLabel+":`"+m.label+"`{`"+q+"`:{`"+r+"`}})")}else e.push("("+l.internalLabel+":`"+l.label+"`)-["+p+":`"+d.label+"`]"+n+"("+m.internalLabel+
":`"+m.label+"`)")});return{matchElements:e,whereElements:g,relationElements:h,parameters:k}};a.query.getRelevantLinks=function(a,c,d){var b=d.slice(),e=[],g=[];b.forEach(function(a){(a.target.value||a.target===c)&&e.push(a)});e.forEach(function(a){b.splice(b.indexOf(a),1)});e.forEach(function(c){var d=c.source;for(c=!0;c;){var e=null;b.forEach(function(a){a.target===d&&(e=a)});null===e?c=!1:e.source===a?(g.push(e),b.splice(b.indexOf(e),1),c=!1):(g.push(e),b.splice(b.indexOf(e),1),d=e.source)}});
return e.concat(g)};a.query.getLinksToRoot=function(b,c){for(var d=[],f=b;f!==a.graph.getRootNode();){for(var e,g=0;g<c.length;g++){var h=c[g];if(h.target===f){e=h;break}}e&&(d.push(e),f=e.source)}return d};a.query.generateResultQuery=function(b){var c=a.graph.getRootNode(),d=a.query.generateQueryElements(c,c,a.query.getRelevantLinks(c,c,a.graph.force.links()),!0),f=d.matchElements,e=d.whereElements,g=d.relationElements,h=[],k=[],d=d.parameters,n=a.provider.getResultOrderByAttribute(c.label);if(n){var l=
a.provider.isResultOrderAscending(c.label)?"ASC":"DESC";k.push("ORDER BY "+n+" "+l)}k.push("LIMIT "+a.query.RESULTS_PAGE_SIZE);n=a.provider.getReturnAttributes(c.label);l=a.provider.getConstraintAttribute(c.label);if(b)h.push(c.internalLabel),g.forEach(function(a){h.push(a)});else for(b=0;b<n.length;b++)g=n[b],g===a.query.NEO4J_INTERNAL_ID?g==l?h.push("ID("+c.internalLabel+") AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):h.push("COLLECT(DISTINCT ID("+c.internalLabel+")) AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):
g==l?h.push(c.internalLabel+"."+g+" AS "+g):h.push("COLLECT(DISTINCT "+c.internalLabel+"."+g+") AS "+g);b="MATCH "+f.join(", ")+(0<e.length?" WHERE "+e.join(" AND "):"")+" RETURN DISTINCT "+h.join(", ")+" "+k.join(" ");c=a.provider.filterResultQuery(c.label,{statement:b,matchElements:f,whereElements:e,returnElements:h,endElements:k,parameters:d});return{statement:c.statement,parameters:c.parameters}};a.query.generateNodeCountQuery=function(b){var c=a.query.generateQueryElements(a.graph.getRootNode(),
b,a.query.getRelevantLinks(a.graph.getRootNode(),b,a.graph.force.links()),!0),d=c.matchElements,f=c.whereElements,e=[],c=c.parameters,g=a.provider.getConstraintAttribute(b.label);g===a.query.NEO4J_INTERNAL_ID?e.push("count(DISTINCT ID("+b.internalLabel+")) as count"):e.push("count(DISTINCT "+b.internalLabel+"."+g+") as count");g="MATCH "+d.join(", ")+(0<f.length?" WHERE "+f.join(" AND "):"")+" RETURN "+e.join(", ");b=a.provider.filterNodeCountQuery(b,{statement:g,matchElements:d,whereElements:f,returnElements:e,
endElements:[],parameters:c});return{statement:b.statement,parameters:b.parameters}};a.query.generateNodeValueQuery=function(b){var c=a.graph.getRootNode(),d=a.query.generateQueryElements(c,b,a.query.getRelevantLinks(c,b,a.graph.force.links()),!0),f=d.matchElements,e=d.whereElements,g=[],h=[],d=d.parameters,k=a.provider.getValueOrderByAttribute(b.label);if(k){var n=a.provider.isValueOrderAscending(b.label)?"ASC":"DESC";h.push("ORDER BY "+k+" "+n)}h.push("LIMIT "+a.query.VALUE_QUERY_LIMIT);for(var k=
a.provider.getReturnAttributes(b.label),n=a.provider.getConstraintAttribute(b.label),l=0;l<k.length;l++)k[l]===a.query.NEO4J_INTERNAL_ID?k[l]==n?g.push("ID("+b.internalLabel+") AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):g.push("COLLECT (DISTINCT ID("+b.internalLabel+")) AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):k[l]==n?g.push(b.internalLabel+"."+k[l]+" AS "+k[l]):g.push("COLLECT(DISTINCT "+b.internalLabel+"."+k[l]+") AS "+k[l]);k=a.provider.getConstraintAttribute(c.label);k===a.query.NEO4J_INTERNAL_ID?
g.push("count(DISTINCT ID("+c.internalLabel+")) AS count"):g.push("count(DISTINCT "+c.internalLabel+"."+k+") AS count");c="MATCH "+f.join(", ")+(0<e.length?" WHERE "+e.join(" AND "):"")+" RETURN DISTINCT "+g.join(", ")+" "+h.join(" ");b=a.provider.filterNodeValueQuery(b,{statement:c,matchElements:f,whereElements:e,returnElements:g,endElements:h,parameters:d});return{statement:b.statement,parameters:b.parameters}};a.query.generateNodeRelationQuery=function(b){var c=a.query.getLinksToRoot(b,a.graph.force.links()),
d=a.query.generateQueryElements(a.graph.getRootNode(),b,c,!1),c=d.matchElements,f=d.whereElements,e=[],g=[],d=d.parameters;c.push("("+b.internalLabel+":`"+b.label+"`)-[r]"+(a.query.USE_RELATION_DIRECTION?"->":"-")+"(x)");e.push("type(r) AS relationship");a.query.USE_PARENT_RELATION?e.push("head(labels(x)) AS label"):e.push("last(labels(x)) AS label");e.push("count(r) AS count");g.push("ORDER BY count(r) DESC");var h="MATCH "+c.join(", ")+(0<f.length?" WHERE "+f.join(" AND "):"")+" RETURN "+e.join(", ")+
" "+g.join(" ");b=a.provider.filterNodeRelationQuery(b,{statement:h,matchElements:c,whereElements:f,returnElements:e,endElements:g,parameters:d});return{statement:b.statement,parameters:b.parameters}};a.result={};a.result.containerId="popoto-results";a.result.hasChanged=!0;a.result.resultCountListeners=[];a.result.resultListeners=[];a.result.graphResultListeners=[];a.result.onTotalResultCount=function(b){a.result.resultCountListeners.push(b)};a.result.onResultReceived=function(b){a.result.resultListeners.push(b)};
a.result.onGraphResultReceived=function(b){a.result.graphResultListeners.push(b)};a.result.parseResultData=function(b){var c=[];if(b&&b.hasOwnProperty("results")&&0<b.results.length)for(var d=0;d<b.results[0].data.length;d++){for(var f={resultIndex:d,label:a.graph.getRootNode().label,attributes:{}},e=0;e<b.results[0].columns.length;e++)f.attributes[b.results[0].columns[e]]=""+b.results[0].data[d].row[e];c.push(f)}return c};a.result.parseGraphResultData=function(a){var b={},d={};a.results[1].data.forEach(function(a){a.graph.nodes.forEach(function(a){b.hasOwnProperty(a.id)||
(b[a.id]=a)});a.graph.relationships.forEach(function(a){d.hasOwnProperty(a.id)||(d[a.id]=a)})});a=[];var f=[],e;for(e in b)b.hasOwnProperty(e)&&a.push(b[e]);for(var g in d)d.hasOwnProperty(g)&&f.push(d[g]);return{nodes:a,edges:f}};a.result.updateResults=function(){if(a.result.hasChanged){var b=a.query.generateResultQuery(),b={statements:[{statement:b.statement,parameters:b.parameters,resultDataContents:["row"]}]};if(0<a.result.graphResultListeners.length){var c=a.query.generateResultQuery(!0);b.statements.push({statement:c.statement,
parameters:c.parameters,resultDataContents:["graph"]})}a.logger.info("Results ==> ");a.rest.post(b).done(function(b){b.errors&&0<b.errors.length&&a.logger.error("Cypher query error:"+JSON.stringify(b.errors));var c=a.result.parseResultData(b);a.result.resultListeners.forEach(function(a){a(c)});if(0<a.result.graphResultListeners.length){var d=a.result.parseGraphResultData(b);a.result.graphResultListeners.forEach(function(a){a(d)})}a.result.isActive&&(b=d3.select("#"+a.result.containerId).selectAll(".ppt-result").data([]),
b.exit().remove(),b=d3.select("#"+a.result.containerId).selectAll(".ppt-result").data(c,function(a){return a.resultIndex}),b.enter().append("p").attr("class","ppt-result").attr("id",function(a){return"popoto-result-"+a.resultIndex}).each(function(b){a.provider.getDisplayResultFunction(b.label)(d3.select(this))}));a.result.hasChanged=!1}).fail(function(b,c,e){a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+e);a.result.resultListeners.forEach(function(a){a([])})})}};
a.result.updateResultsCount=function(){0<a.result.resultCountListeners.length&&a.result.resultCountListeners.forEach(function(b){b(a.graph.getRootNode().count)})};a.provider={};a.provider.linkProvider={};a.provider.taxonomyProvider={};a.provider.nodeProviders={};a.provider.getLinkTextValue=function(b){if(a.provider.linkProvider.hasOwnProperty("getLinkTextValue"))return a.provider.linkProvider.getLinkTextValue(b);if(a.provider.DEFAULT_LINK_PROVIDER.hasOwnProperty("getLinkTextValue"))return a.provider.DEFAULT_LINK_PROVIDER.getLinkTextValue(b);
a.logger.error("No provider defined for getLinkTextValue")};a.provider.getLinkSemanticValue=function(b){if(a.provider.linkProvider.hasOwnProperty("getLinkSemanticValue"))return a.provider.linkProvider.getLinkSemanticValue(b);if(a.provider.DEFAULT_LINK_PROVIDER.hasOwnProperty("getLinkSemanticValue"))return a.provider.DEFAULT_LINK_PROVIDER.getLinkSemanticValue(b);a.logger.error("No provider defined for getLinkSemanticValue")};a.provider.DEFAULT_LINK_PROVIDER=Object.freeze({getLinkTextValue:function(b){return b.type===
a.graph.link.LinkTypes.VALUE?a.provider.isTextDisplayed(b.target)?"":a.provider.getTextValue(b.target):b.label},getLinkSemanticValue:function(b){return a.provider.getLinkTextValue(b)}});a.provider.linkProvider=a.provider.DEFAULT_LINK_PROVIDER;a.provider.getTaxonomyTextValue=function(b){if(a.provider.taxonomyProvider.hasOwnProperty("getTextValue"))return a.provider.taxonomyProvider.getTextValue(b);if(a.provider.DEFAULT_TAXONOMY_PROVIDER.hasOwnProperty("getTextValue"))return a.provider.DEFAULT_TAXONOMY_PROVIDER.getTextValue(b);
a.logger.error("No provider defined for taxonomy getTextValue")};a.provider.DEFAULT_TAXONOMY_PROVIDER=Object.freeze({getTextValue:function(a){return a}});a.provider.taxonomyProvider=a.provider.DEFAULT_TAXONOMY_PROVIDER;a.provider.NodeDisplayTypes=Object.freeze({TEXT:0,IMAGE:1,SVG:2});a.provider.getProvider=function(b){if(void 0===b)a.logger.error("Node label is undefined, no label provider can be found.");else{if(!a.provider.nodeProviders.hasOwnProperty(b)){a.logger.debug("No direct provider found for label "+
b);for(var c in a.provider.nodeProviders)if(a.provider.nodeProviders.hasOwnProperty(c)){var d=a.provider.nodeProviders[c];if(d.hasOwnProperty("children")&&-1<d.children.indexOf(b)){a.logger.debug("No provider is defined for label ("+b+"), parent ("+c+") will be used");c={parent:c};for(var f in d)d.hasOwnProperty(f)&&"children"!=f&&"parent"!=f&&(c[f]=d[f]);a.provider.nodeProviders[b]=c;return a.provider.nodeProviders[b]}}a.logger.debug("No label provider defined for label ("+b+") default one will be created from popoto.provider.DEFAULT_PROVIDER");
a.provider.nodeProviders[b]={};for(var e in a.provider.DEFAULT_PROVIDER)a.provider.DEFAULT_PROVIDER.hasOwnProperty(e)&&(a.provider.nodeProviders[b][e]=a.provider.DEFAULT_PROVIDER[e])}return a.provider.nodeProviders[b]}};a.provider.getProperty=function(b,c){var d=a.provider.getProvider(b);if(!d.hasOwnProperty(c)){for(var f=d,e=!1;f.hasOwnProperty("parent")&&!e;)f=a.provider.getProvider(f.parent),f.hasOwnProperty(c)&&(d[c]=f[c],e=!0);e||(a.logger.debug('No "'+c+'" property found for node label provider ('+
b+"), default value will be used"),a.provider.DEFAULT_PROVIDER.hasOwnProperty(c)?d[c]=a.provider.DEFAULT_PROVIDER[c]:a.logger.debug('No default value for "'+c+'" property found for label provider ('+b+")"))}return d[c]};a.provider.getIsSearchable=function(b){return a.provider.getProperty(b,"isSearchable")};a.provider.getIsAutoExpandRelations=function(b){return a.provider.getProperty(b,"autoExpandRelations")};a.provider.getSchema=function(b){return a.provider.getProperty(b,"schema")};a.provider.getReturnAttributes=
function(b){var c=a.provider.getProvider(b),d={};if(c.hasOwnProperty("returnAttributes"))for(var f=0;f<c.returnAttributes.length;f++)c.returnAttributes[f]===a.query.NEO4J_INTERNAL_ID?d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=!0:d[c.returnAttributes[f]]=!0;for(;c.hasOwnProperty("parent");)if(c=a.provider.getProvider(c.parent),c.hasOwnProperty("returnAttributes"))for(f=0;f<c.returnAttributes.length;f++)c.returnAttributes[f]===a.query.NEO4J_INTERNAL_ID?d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=
!0:d[c.returnAttributes[f]]=!0;if(a.provider.DEFAULT_PROVIDER.hasOwnProperty("returnAttributes"))for(c=0;c<a.provider.DEFAULT_PROVIDER.returnAttributes.length;c++)a.provider.DEFAULT_PROVIDER.returnAttributes[c]!==a.query.NEO4J_INTERNAL_ID&&(d[a.provider.DEFAULT_PROVIDER.returnAttributes[c]]=!0);b=a.provider.getConstraintAttribute(b);b===a.query.NEO4J_INTERNAL_ID?d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=!0:d[b]=!0;b=[];for(var e in d)d.hasOwnProperty(e)&&(e==a.query.NEO4J_INTERNAL_ID.queryInternalName?
b.push(a.query.NEO4J_INTERNAL_ID):b.push(e));0>=b.length&&b.push(a.query.NEO4J_INTERNAL_ID);return b};a.provider.getConstraintAttribute=function(b){return a.provider.getProperty(b,"constraintAttribute")};a.provider.getPredefinedConstraints=function(b){return a.provider.getProperty(b,"getPredefinedConstraints")()};a.provider.filterResultQuery=function(b,c){return a.provider.getProperty(b,"filterResultQuery")(c)};a.provider.getValueOrderByAttribute=function(b){return a.provider.getProperty(b,"valueOrderByAttribute")};
a.provider.isValueOrderAscending=function(b){return a.provider.getProperty(b,"isValueOrderAscending")};a.provider.getResultOrderByAttribute=function(b){return a.provider.getProperty(b,"resultOrderByAttribute")};a.provider.isResultOrderAscending=function(b){return a.provider.getProperty(b,"isResultOrderAscending")};a.provider.getTextValue=function(b){return a.provider.getProperty(b.label,"getTextValue")(b)};a.provider.getTextValue=function(b){return a.provider.getProperty(b.label,"getTextValue")(b)};
a.provider.getSemanticValue=function(b){return a.provider.getProperty(b.label,"getSemanticValue")(b)};a.provider.getSVGPaths=function(b){return a.provider.getProperty(b.label,"getSVGPaths")(b)};a.provider.isTextDisplayed=function(b){return a.provider.getProperty(b.label,"getIsTextDisplayed")(b)};a.provider.getIsGroup=function(b){return a.provider.getProperty(b.label,"getIsGroup")(b)};a.provider.getNodeDisplayType=function(b){return a.provider.getProperty(b.label,"getDisplayType")(b)};a.provider.getImagePath=
function(b){return a.provider.getProperty(b.label,"getImagePath")(b)};a.provider.getImageWidth=function(b){return a.provider.getProperty(b.label,"getImageWidth")(b)};a.provider.getImageHeight=function(b){return a.provider.getProperty(b.label,"getImageHeight")(b)};a.provider.filterNodeValueQuery=function(b,c){return a.provider.getProperty(b.label,"filterNodeValueQuery")(b,c)};a.provider.filterNodeCountQuery=function(b,c){return a.provider.getProperty(b.label,"filterNodeCountQuery")(b,c)};a.provider.filterNodeRelationQuery=
function(b,c){return a.provider.getProperty(b.label,"filterNodeRelationQuery")(b,c)};a.provider.getDisplayResultFunction=function(b){return a.provider.getProperty(b,"displayResults")};a.provider.DEFAULT_PROVIDER={isSearchable:!0,autoExpandRelations:!1,returnAttributes:[a.query.NEO4J_INTERNAL_ID],valueOrderByAttribute:"count",isValueOrderAscending:!1,resultOrderByAttribute:null,isResultOrderAscending:!0,constraintAttribute:a.query.NEO4J_INTERNAL_ID,getPredefinedConstraints:function(){return[]},filterResultQuery:function(a){return a},
getDisplayType:function(b){return a.provider.NodeDisplayTypes.TEXT},getIsGroup:function(a){return!1},getIsTextDisplayed:function(a){return!0},getTextValue:function(b){var c=a.provider.getProperty(b.label,"constraintAttribute");return(b.type===a.graph.node.NodeTypes.VALUE?c===a.query.NEO4J_INTERNAL_ID?""+b.internalID:""+b.attributes[c]:void 0===b.value?b.label:c===a.query.NEO4J_INTERNAL_ID?""+b.value.internalID:""+b.value.attributes[c]).substring(0,a.graph.node.NODE_MAX_CHARS)},getSemanticValue:function(b){var c=
a.provider.getProperty(b.label,"constraintAttribute");return b.type===a.graph.node.NodeTypes.VALUE?c===a.query.NEO4J_INTERNAL_ID?""+b.internalID:""+b.attributes[c]:void 0===b.value?b.label:c===a.query.NEO4J_INTERNAL_ID?""+b.value.internalID:""+b.value.attributes[c]},getImagePath:function(b){if(b.type===a.graph.node.NodeTypes.VALUE)return"css/image/node-yellow.png";if(void 0===b.value){if(b.type===a.graph.node.NodeTypes.ROOT)return"css/image/node-blue.png";if(b.type===a.graph.node.NodeTypes.CHOOSE)return"css/image/node-green.png";
if(b.type===a.graph.node.NodeTypes.GROUP)return"css/image/node-black.png"}else return"css/image/node-orange.png"},getImageWidth:function(a){return 125},getImageHeight:function(a){return 125},filterNodeValueQuery:function(a,c){return c},filterNodeCountQuery:function(a,c){return c},filterNodeRelationQuery:function(a,c){return c},displayResults:function(b){var c=b.data()[0],d=a.provider.getReturnAttributes(c.label),f=b.append("table").attr("class","ppt-result-table");d.forEach(function(b){var d=b;a.query.NEO4J_INTERNAL_ID===
b&&(d=a.query.NEO4J_INTERNAL_ID.queryInternalName);var e=f.append("tr");e.append("th").text(function(){return b===a.query.NEO4J_INTERNAL_ID?"internal ID:":b+":"});void 0!==c.attributes[d]&&e.append("td").text(function(a){return a.attributes[d]})})}};return a}();
